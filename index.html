<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教學平台測驗題目生成器 v2.5 | 為老師設計</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS/xlsx library for creating .xlsx files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- pdf.js for reading PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght=400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f3ff; /* Fallback */
            background-image: linear-gradient(to top right, #f5f3ff, #eef2ff); /* Gradient background */
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366f1; /* Indigo color for loader */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-preview-item {
            position: relative;
        }
        .remove-image-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
            transition: background-color 0.2s;
        }
        .remove-image-btn:hover {
            background-color: rgba(239, 68, 68, 0.9); /* Red on hover */
        }
        .custom-divider {
            position: relative;
            text-align: center;
        }
        .custom-divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 45%;
            height: 1px;
            background-color: #d1d5db; /* gray-300 */
        }
        .custom-divider::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            width: 45%;
            height: 1px;
            background-color: #d1d5db; /* gray-300 */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-700">教學平台測驗題目生成器</h1>
            <p class="text-lg text-gray-500 mt-3">專為國中小老師設計，一鍵生成 Wordwall, Kahoot, Wayground, LoiLoNote 格式測驗</p>
        </header>

        <!-- Main Content Layout -->
        <main class="max-w-4xl mx-auto space-y-8">

            <!-- Step 1: Input -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold mb-5 text-indigo-600 flex items-center"><span class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3">1</span>提供內容</h2>
                <div class="space-y-6">
                    <div>
                        <label for="text-input" class="block text-sm font-medium text-gray-700 mb-1">貼上文章或教學內容 (可選)：</label>
                        <textarea id="text-input" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="請在此貼上您的教學文字內容..."></textarea>
                    </div>
                    
                    <div class="custom-divider text-gray-400 font-medium">或</div>

                    <div>
                        <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">上傳文字檔 (可選)：</label>
                        <label for="file-input" class="flex flex-col items-center justify-center w-full h-32 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-lg appearance-none cursor-pointer hover:border-indigo-400 focus:outline-none hover:bg-indigo-50">
                            <span class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 S0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span class="font-medium text-gray-600">
                                    點擊此處上傳文字檔
                                    <span class="text-indigo-600">或拖曳檔案到這裡</span>
                                </span>
                            </span>
                             <p class="text-xs text-gray-500 mt-1">支援 .txt 及 .pdf 格式</p>
                        </label>
                        <input type="file" id="file-input" class="hidden" accept=".txt,.pdf">
                        <p id="file-name-display" class="mt-2 text-sm text-center text-gray-600"></p>
                    </div>
                     
                    <div class="custom-divider text-gray-400 font-medium">+</div>

                    <div>
                        <label for="image-input" class="block text-sm font-medium text-gray-700 mb-2">上傳圖片 (可選，支援多張圖片)：</label>
                        <label for="image-input" class="flex flex-col items-center justify-center w-full h-32 px-4 transition bg-white border-2 border-gray-300 border-dashed rounded-lg appearance-none cursor-pointer hover:border-indigo-400 focus:outline-none hover:bg-indigo-50">
                            <span class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="font-medium text-gray-600">
                                    點擊此處上傳圖片
                                    <span class="text-indigo-600">或拖曳檔案到這裡</span>
                                </span>
                            </span>
                             <p class="text-xs text-gray-500 mt-1">支援 .jpg, .png, .gif, .webp 格式</p>
                        </label>
                        <input type="file" id="image-input" class="hidden" accept="image/*" multiple>
                        <div id="image-preview-container" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Options -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold mb-5 text-indigo-600 flex items-center"><span class="bg-indigo-600 text-white rounded-full h-8 w-8 flex items-center justify-center mr-3">2</span>設定選項</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="num-questions" class="block text-sm font-medium text-gray-700">您希望生成幾道題目？</label>
                        <input type="number" id="num-questions" value="5" min="1" max="20" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="format-select" class="block text-sm font-medium text-gray-700">請選擇匯出檔案格式：</label>
                        <select id="format-select" class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-[50px]">
                            <option value="" disabled selected>請選擇...</option>
                            <option value="wordwall">Wordwall</option>
                            <option value="kahoot">Kahoot!</option>
                            <option value="wayground">Wayground</option>
                            <option value="loilonote">LoiLoNote</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Step 3: Generate and Download Button -->
            <div class="mt-8">
                <button id="generate-and-download-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:-translate-y-1 flex items-center justify-center text-xl shadow-lg hover:shadow-xl hover:shadow-indigo-500/30">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    生成並下載測驗檔案
                </button>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p><span id="version-btn" class="cursor-pointer hover:text-indigo-600 hover:underline">v2.5</span> | 由 Google Gemini 強力驅動 | <a href="https://bit.ly/Aliang" target="_blank" class="text-indigo-500 hover:underline">丫亮校長練功坊</a></p>
        </footer>

    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loader"></div>
            <p class="mt-4 text-lg font-semibold text-gray-700">AI 正在為您生成題目，請稍候...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- Version History Modal -->
    <div id="version-modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 max-w-lg relative">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4">版本修正歷程</h3>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <div id="version-history-content" class="space-y-4 max-h-80 overflow-y-auto pr-4">
                <!-- History will be populated by script -->
            </div>
        </div>
    </div>


<script>
    // Set up pdf.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

    // DOM Elements
    const textInput = document.getElementById('text-input');
    const fileInput = document.getElementById('file-input');
    const fileNameDisplay = document.getElementById('file-name-display');
    const imageInput = document.getElementById('image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const numQuestionsInput = document.getElementById('num-questions');
    const formatSelect = document.getElementById('format-select');
    const generateAndDownloadBtn = document.getElementById('generate-and-download-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const versionBtn = document.getElementById('version-btn');
    const versionModal = document.getElementById('version-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const versionHistoryContent = document.getElementById('version-history-content');
    
    // --- Version History Data ---
    const versionHistory = [
        { version: "v2.5", current: true, notes: ["擴充版本歷史紀錄，從v1.0開始完整呈現。"] },
        { version: "v2.4", notes: ["新增版本歷史紀錄彈出式視窗。"] },
        { version: "v2.3", notes: ["全面美化使用者介面，放大標題與元件。", "優化卡片式佈局與陰影效果。"] },
        { version: "v2.2", notes: ["統一「上傳文字檔」與「上傳圖片」的UI風格。"] },
        { version: "v2.1", notes: ["新增上傳多張圖片並進行AI辨識出題的功能。"] },
        { version: "v2.0", notes: ["參照新設計風格，大幅更新UI/UX配色與版面配置。"] },
        { version: "v1.3", notes: ["為「Wayground」格式增加AI自動生成答案說明的支援。"] },
        { version: "v1.2", notes: ["修正「Wordwall」格式，正確選項改為數字索引。", "新增頁尾版本資訊與作者連結。"] },
        { version: "v1.1", notes: ["新增「LoiLoNote」匯出格式。", "為「LoiLoNote」格式增加AI自動生成答案說明。"] },
        { version: "v1.0", notes: ["程式建立：支援文字輸入，智慧生成題目。", "支援匯出 Wordwall, Kahoot, Wayground 格式。", "確立核心流程：提供內容 -> 設定選項 -> 生成下載。"] }
    ];

    function populateVersionHistory() {
        let html = '';
        versionHistory.forEach(v => {
            html += `
                <div>
                    <h4 class="font-bold text-lg">${v.version} ${v.current ? '<span class="text-sm font-normal text-indigo-600">(目前版本)</span>' : ''}</h4>
                    <ul class="list-disc list-inside text-gray-600">
                        ${v.notes.map(note => `<li>${note}</li>`).join('')}
                    </ul>
                </div>
            `;
        });
        versionHistoryContent.innerHTML = html;
    }


    /**
     * Main handler to start the generation and export process.
     */
    async function handleGenerateAndDownload() {
        const text = textInput.value;
        const numQuestions = numQuestionsInput.value;
        const selectedFormat = formatSelect.value;

        // Validation
        if (!text.trim() && uploadedImages.length === 0) {
            showToast('請先輸入文字、或上傳圖片！', 'error');
            return;
        }
        if (!selectedFormat) {
            showToast('請選擇匯出檔案格式！', 'error');
            return;
        }

        loadingOverlay.classList.remove('hidden');
        
        // --- START: API KEY 替換為代理服務 ---
        // 代理 API 的 URL。請將此替換為您 Cloudflare Worker 或其他 Serverless Function 的完整 URL。
        const PROXY_API_URL = 'quiz-gemini-proxy.fuwen.workers.dev'; 
        // --- END: API KEY 替換為代理服務 ---

        let systemPrompt;
        let jsonSchema;

        // LoiLoNote and Wayground require explanations
        if (selectedFormat === 'loilonote' || selectedFormat === 'wayground') {
            systemPrompt = `你是一位協助國中小老師出題的助手。請根據使用者提供的文本和圖片，生成${numQuestions}題選擇題。每題需要有4個選項、清楚標示哪一個是正確答案（答案的索引值從0開始），並針對正確答案提供簡短的說明。輸出的格式必須是嚴格的JSON陣列，陣列中包含多個題目物件，不可包含JSON以外的任何文字或註解。`;
            jsonSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        text: { type: "STRING", description: "題目文字" },
                        options: { type: "ARRAY", description: "包含4個選項文字的陣列", items: { type: "STRING" } },
                        correct: { type: "ARRAY", description: "包含正確答案索引值的陣列 (例如 [0])", items: { type: "INTEGER" } },
                        time: { type: "INTEGER", description: "答題秒數, 預設為 30" },
                        explanation: { type: "STRING", description: "針對正確答案的簡短說明" }
                    },
                    required: ["text", "options", "correct", "time", "explanation"]
                }
            };
        } else { // Other formats don't require explanations
            systemPrompt = `你是一位協助國中小老師出題的助手。請根據使用者提供的文本和圖片，生成${numQuestions}題選擇題。每題需要有4個選項，並清楚標示哪一個是正確答案（答案的索引值從0開始）。輸出的格式必須是嚴格的JSON陣列，陣列中包含多個題目物件，不可包含JSON以外的任何文字或註解。`;
            jsonSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        text: { type: "STRING", description: "題目文字" },
                        options: { type: "ARRAY", description: "包含4個選項文字的陣列", items: { type: "STRING" } },
                        correct: { type: "ARRAY", description: "包含正確答案索引值的陣列 (例如 [0])", items: { type: "INTEGER" } },
                        time: { type: "INTEGER", description: "答題秒數, 預設為 30" }
                    },
                    required: ["text", "options", "correct", "time"]
                }
            };
        }
        
        // Construct parts for the LLM
        const parts = [];
        const userPrompt = "請根據以下提供的文字和圖片內容出題。";
        parts.push({ text: userPrompt });
        if(text.trim()){
             parts.push({ text: `文字內容:\n${text}`});
        }
        uploadedImages.forEach(img => {
            parts.push({
                inlineData: {
                    mimeType: img.type,
                    data: img.data
                }
            });
        });

        // 這是要傳遞給代理服務的最終 payload 結構
        const proxyPayload = {
            model: 'gemini-2.5-flash-preview-05-20', // 指定模型名稱，讓代理服務知道要呼叫哪個端點
            requestBody: { // 這是原本要發送給 Google API 的內容
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json", responseSchema: jsonSchema }
            }
        };

        try {
            // 對代理服務發起請求
            const response = await fetch(PROXY_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(proxyPayload)
            });

            if (!response.ok) {
                // 處理代理服務返回的錯誤
                let errorDetails = response.statusText;
                try {
                    const errorBody = await response.json();
                    errorDetails = errorBody.error || errorDetails;
                } catch {}

                throw new Error(`生成服務失敗: ${response.status} ${errorDetails}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!jsonText) {
                throw new Error('API 回應中找不到有效的題目內容。');
            }

            const generatedQs = JSON.parse(jsonText);
            exportFile(selectedFormat, generatedQs);

        } catch (error) {
            console.error('生成題目時發生錯誤:', error);
            showToast(error.message, 'error');
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }
    
    // --- File Handling (Text/PDF) ---
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
            fileNameDisplay.textContent = '';
            return;
        }
        fileNameDisplay.textContent = `已選擇檔案：${file.name}`;
        const reader = new FileReader();
        if (file.type === 'application/pdf') {
            reader.onload = async (e) => {
                const typedarray = new Uint8Array(e.target.result);
                try {
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ');
                    }
                    textInput.value = text;
                } catch (error) {
                    console.error("讀取PDF失敗:", error);
                    showToast("無法讀取此PDF檔案。", "error");
                    fileNameDisplay.textContent = '';
                }
            };
            reader.readAsArrayBuffer(file);
        } else { // Assume text file
            reader.onload = (e) => { textInput.value = e.target.result; };
            reader.readAsText(file);
        }
    });

    // --- Image Handling ---
    let uploadedImages = []; // To store { type, data } for each image
    imageInput.addEventListener('change', (event) => {
        const files = event.target.files;
        if (!files) return;

        // Reset
        imagePreviewContainer.innerHTML = '';
        uploadedImages = [];
        
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const fullBase64 = e.target.result;
                const base64Data = fullBase64.split(',')[1];
                
                // Store image data
                const imageObject = {
                    id: Date.now() + index, // unique id
                    type: file.type,
                    data: base64Data
                };
                uploadedImages.push(imageObject);

                // Create preview element
                const previewWrapper = document.createElement('div');
                previewWrapper.className = 'image-preview-item';
                
                const imgElement = document.createElement('img');
                imgElement.src = fullBase64;
                imgElement.className = 'w-full h-32 object-cover rounded-lg shadow-md';
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-image-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    // Remove from array and DOM
                    uploadedImages = uploadedImages.filter(img => img.id !== imageObject.id);
                    previewWrapper.remove();
                };

                previewWrapper.appendChild(imgElement);
                previewWrapper.appendChild(removeBtn);
                imagePreviewContainer.appendChild(previewWrapper);
            };
            reader.readAsDataURL(file);
        });
    });


    // --- Export Function ---
    function exportFile(format, questions) {
        if (!questions || questions.length === 0) {
            showToast('沒有可匯出的題目！', 'error');
            return;
        }
        let data, filename;
        try {
            switch (format) {
                case 'wordwall':
                    data = questions.map(q => ({
                        '問題': q.text,
                        '選項1': q.options[0] || '', '選項2': q.options[1] || '',
                        '選項3': q.options[2] || '', '選項4': q.options[3] || '',
                        '正確選項': q.correct.length > 0 ? (q.correct[0] + 1) : '',
                    }));
                    filename = 'Wordwall_Quiz.xlsx';
                    break;
                case 'kahoot':
                    const kahootData = [
                        ['Kahoot Quiz Template'], ['Add questions, answers, and time limits. Have fun!'], [], [],
                        ['Question', 'Answer 1', 'Answer 2', 'Answer 3', 'Answer 4', 'Time limit (sec)', 'Correct answer(s)']
                    ];
                    questions.forEach(q => {
                        kahootData.push([
                            q.text,
                            q.options[0] || '', q.options[1] || '', q.options[2] || '', q.options[3] || '',
                            q.time, q.correct.map(i => i + 1).join(',')
                        ]);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(kahootData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                    XLSX.writeFile(wb, 'Kahoot_Quiz.xlsx');
                    showToast('Kahoot 檔案已下載！', 'success');
                    return;
                case 'wayground':
                    data = questions.map(q => ({
                        'Question Text': q.text,
                        'Question Type': q.correct.length > 1 ? 'Checkbox' : 'Multiple Choice',
                        'Option 1': q.options[0] || '', 'Option 2': q.options[1] || '',
                        'Option 3': q.options[2] || '', 'Option 4': q.options[3] || '',
                        'Option 5': '', 'Correct Answer': q.correct.map(i => i + 1).join(','),
                        'Time in seconds': q.time, 'Image Link': '',
                        'Answer explanation': q.explanation || ''
                    }));
                    filename = 'Wayground_Quiz.xlsx';
                    break;
                case 'loilonote':
                    data = questions.map(q => ({
                        '問題（請勿編輯標題）': q.text,
                        '務必作答（若此問題需要回答，請輸入1）': 1,
                        '每題得分（未填入的部分將被自動設為1）': 1,
                        '正確答案的選項（若有複數正確答案選項，請用「、」或「 , 」來分隔選項編號）': q.correct.map(i => i + 1).join(','),
                        '說明': q.explanation || '',
                        '選項1': q.options[0] || '', '選項2': q.options[1] || '',
                        '選項3': q.options[2] || '', '選項4': q.options[3] || '',
                    }));
                    filename = 'LoiLoNote_Quiz.xlsx';
                    break;
                default: throw new Error('Unknown format');
            }
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
            XLSX.writeFile(workbook, filename);
            showToast(`${format.charAt(0).toUpperCase() + format.slice(1)} 檔案已下載！`, 'success');
        } catch (error) {
            console.error('Export failed:', error);
            showToast('匯出失敗，請檢查主控台錯誤。', 'error');
        }
    };
    
    // --- Utility Functions ---
    function showToast(message, type = 'success') {
        toastMessage.textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        toast.classList.remove('opacity-0');
        setTimeout(() => { toast.classList.add('opacity-0'); }, 3000);
    }

    // --- Initial setup on page load ---
    document.addEventListener('DOMContentLoaded', () => {
        populateVersionHistory();
    });

    // --- Event Listeners ---
    generateAndDownloadBtn.addEventListener('click', handleGenerateAndDownload);

    versionBtn.addEventListener('click', () => {
        versionModal.classList.remove('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
        versionModal.classList.add('hidden');
    });

    versionModal.addEventListener('click', (event) => {
        if (event.target === versionModal) { // Close if clicked on overlay
            versionModal.classList.add('hidden');
        }
    });
    
</script>

</body>
</html>
